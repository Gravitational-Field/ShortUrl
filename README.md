## 高性能短链系统

### 简介

本文将从以下几个方面进行探索与实现：

- 短链有什么好处
- 短链系统的基本原理
- 短链生成的几种方法
- 高性能短链的架构设计

### 短链有什么好处

1、链接变短，在对内容长度有限制的平台发文，可编辑的文字就变多了； 如微博限定字数140、短信按照发文长短收费等

2、我们经常需要将链接转成二维码的形式分享给他人，如果是长链的话二维码密集难识别，短链就不存在这个问题了。

![image-20210316212119809](README.assets/image-20210316212119809.png)

3、 链接太长在有些平台上无法自动识别为超链接； 如钉钉，无法识别长链接，只能识别部分，用短地址则没有问题



### 短链系统的基本原理

短链好处多多，它工作原理是怎样的呢？浏览器抓包看看：

![image-20210316214325319](README.assets/image-20210316214325319.png)

可以看到请求后，返回了状态码 302（重定向）与 location 值为长链的响应，然后浏览器会再请求这个长链以得到最终的响应,整个交互流程图如下

![image-20210316214449589](README.assets/image-20210316214449589.png)



![image-20210316214457024](README.assets/image-20210316214457024.png)

主要步骤就是访问短网址后重定向访问 B，那么问题来了，301 和 302 都是重定向，到底该用哪个，这里需要注意一下 301 和 302 的区别：

- 301，代表 **永久重定向**，也就是说第一次请求拿到长链接后，下次浏览器再去请求短链的话，不会向短网址服务器请求了，而是直接从浏览器的缓存里拿，这样在 server 层面就无法获取到短网址的点击数了，如果这个链接刚好是某个活动的链接，也就无法分析此活动的效果。所以我们一般不采用 301。
- **302**，代表 **临时重定向**，也就是说每次去请求短链都会去请求短网址服务器（除非响应中用 Cache-Control 或 Expired 暗示浏览器缓存）,这样就便于 server 统计点击数，所以虽然用 302 会给 server 增加一点压力，但在数据异常重要的今天，这点代码是值得的，所以推荐使用 302！

> https://blog.csdn.net/u012375924/article/details/82806617
>
>  Cache-Control : 为http中**控制缓存**开关的字段，类似的字段还有Pragma与Expires，优先级从高到低是 **Pragma -> Cache-Control -> Expires**
>
> Cache-Control：
>
> 注意：
>
> 1、符合缓存策略时，服务器不会发送新的资源，但不是说客户端和服务器就没有会话了，客户端还是会发请求到服务器的。
>
> 2、 Cache-Control除了在响应中使用，在请求中也可以使用。我们用开发者工具来模拟下请求时带上Cache-Control：勾选Disable cache，刷新页面，可以看到Request Headers中有个字段Cache-Control: no-cache



### 短链生成的几种方法

#### 1、哈希算法

怎样才能生成短链，仔细观察上例中的短链，显然它是由**固定短链域名** + **长链映射**成的一串字母组成，那么长链怎么才能映射成一串字母呢，哈希函数不就用来干这事的吗，于是我们有了以下设计思路

![image-20210316220126880](README.assets/image-20210316220126880.png)

​		哈希函数该怎么取呢，相信肯定有很多人说用 MD5，SHA 等算法，其实这样做有点杀鸡用牛刀了，而且既然是加密就意味着性能上会有损失，我们其实**不关心反向解密的难度**，反而**更关心的是哈希的运算速度**和**冲突概率**。

> md5算法：MD5 Message-Digest Algorithm，md5信息摘要算法，是一种广泛使用的密码散列函数，可以产生16字节（128位）的散列值（hash value），用以保证信息传输的完整与一致。1996年被破解，存在弱点，对于高度安全性的数据建议使用SHA-2算法；2004年，证实MD5算法无法防止碰撞（collision），因此不适用于安全性认证，如[SSL](https://baike.baidu.com/item/SSL/320778)公开密钥认证或是[数字签名](https://baike.baidu.com/item/数字签名/212550)等用途。
>
> sha算法：Secure Hash Algorithm，一种密码散列函数标准。

​		能够满足这样的哈希算法有很多，这里推荐 Google 出品的 MurmurHash 算法，MurmurHash 是一种**非加密型**哈希函数，适用于一般的哈希检索操作。与其它流行的哈希函数相比，对于规律性较强的 key，MurmurHash 的随机分布特征表现更良好。非加密意味着着相比 MD5，SHA 这些函数它的性能肯定更高（实际上性能是 MD5 等加密算法的十倍以上），也正是由于它的这些优点，所以虽然它出现于 2008，但目前已经广泛应用到 Redis、MemCache、Cassandra、HBase、Lucene 等众多著名的软件中。

> [MurmurHash 算法](https://blog.csdn.net/qigaohua/article/details/102839111)  By. CSDN

MurmurHash 提供了两种长度的哈希值，32 bit，128 bit，为了让网址尽可通地短，我们选择 32 bit 的哈希值，32 bit 能表示的最大值近 43 亿，对于中小型公司的业务而言绰绰有余。对上文提到的极客长链做 MurmurHash 计算，得到的哈希值为 3002604296，于是我们现在得到的短链为 固定短链域名+哈希值 = http://gk.link/a/3002604296





## 参考链接

【1】 [项目最近要上一个短链接服务，忙得一腿   ](https://mp.weixin.qq.com/s/KPUuCU-q1SqnHzeyQeQzhw)  By. 微信 CodeSheep